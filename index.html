<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYEDU - AI මෙවලම් එකතුව</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;500&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* --- Existing Layout Styles (Unchanged) --- */
        .stat-item {
            text-align: center; margin-bottom: 20px; padding: 15px; border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); transition: all 0.3s ease;
        }
        .stat-item:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }
        .stat-item h3 { font-size: 2rem; color: #3498db; margin-bottom: 5px; font-weight: bold; }
        .stat-item p { color: #666; font-weight: 500; margin: 0; }
        
        .col-md-6 { flex: 1; padding: 0 15px; }
        .col-md-6 h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1rem; }
        .col-md-6 ul { list-style: none; padding-left: 0; }
        .col-md-6 ul li {
            background-color: #ecf0f1; padding: 8px 15px; margin-bottom: 8px; border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: transform 0.2s;
        }
        .col-md-6 ul li:hover { transform: translateX(5px); background-color: #dce0e1; }
        
        .main-content { display: flex; flex-wrap: wrap; padding: 20px 0; }
        
        .subject-card {
            background-color: white; padding: 20px; margin: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); flex: 1 1 calc(33% - 30px); min-width: 280px;
            text-align: center; transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;
        }
        .subject-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
        .subject-card i { font-size: 3rem; color: #3498db; margin-bottom: 10px; transition: all 0.3s ease; }
        .subject-card:hover i { transform: scale(1.1); color: #2980b9; }
        .subject-card h3 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 5px; }
        
        .header {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%); color: white; padding: 24px 0;
            box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.2); border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; text-align: center;
        }
        .navbar { background-color: #2c3e50; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content-custom {
            background-color: #fefefe; margin: auto; padding: 0; border-radius: 20px;
            width: 95%; max-width: 900px; height: 85vh; /* Fixed height for consistent look */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative;
            display: flex; flex-direction: column; overflow: hidden; animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Tool Specific Themes --- */
        
        /* 1. Chat Theme */
        .theme-chat-bg { background-color: #f0f2f5; background-image: url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png'); }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin-bottom: 8px; font-size: 0.95rem; line-height: 1.4; }
        .chat-user { background: #0084ff; color: white; border-bottom-right-radius: 4px; align-self: flex-end; margin-left: auto; }
        .chat-ai { background: white; color: #1c1e21; border-bottom-left-radius: 4px; align-self: flex-start; border: 1px solid #ddd; }

        /* 2. Code Theme */
        .theme-code-bg { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Fira Code', monospace; }
        .code-input { background-color: #2d2d2d; border: 1px solid #3e3e3e; color: #9cdcfe; font-family: 'Fira Code', monospace; }
        .code-output { background-color: #252526; border-left: 3px solid #0e639c; color: #ce9178; }

        /* 3. Paper/Essay Theme */
        .theme-paper-bg { background-color: #f3f4f6; }
        .paper-sheet { background: white; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-family: 'Merriweather', serif; line-height: 1.8; color: #2c3e50; }
        .paper-input { border: none; border-bottom: 2px solid #e5e7eb; background: transparent; font-family: 'Inter', sans-serif; }

        /* 4. Audio Theme */
        .theme-audio-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .audio-visualizer { display: flex; align-items: center; justify-content: center; height: 60px; gap: 4px; }
        .audio-bar { width: 6px; background: rgba(255,255,255,0.6); border-radius: 3px; animation: bounce 1s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { height: 10px; } 50% { height: 40px; } }

        /* 5. Sticky Note Theme (Idea Generator) */
        .theme-sticky-bg { background-color: #fff7ed; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .sticky-note { background: #fef08a; padding: 15px; box-shadow: 3px 3px 10px rgba(0,0,0,0.1); transform: rotate(-1deg); font-family: 'Kalam', cursive; border-top: 1px solid rgba(255,255,255,0.5); }
        .sticky-note:nth-child(even) { background: #bfdbfe; transform: rotate(1deg); }
        .sticky-note:nth-child(3n) { background: #bbf7d0; transform: rotate(-2deg); }

        /* Tool Grid & Icons */
        .ai-tool-btn { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); min-height: 100px; }
        .ai-tool-btn:hover { transform: translateY(-5px); }
        
        /* Custom Scrollbar for Tool Content */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media (max-width: 768px) {
            #aiToolButtons { grid-template-columns: repeat(2, 1fr); }
            .nav-list { display: none; }
            .modal-content-custom { width: 100%; height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <div class="header">
        <h1 class="text-4xl font-extrabold">AYEDU</h1>
        <p class="mt-2 text-lg">ශ්‍රී ලංකාවේ උසස් පෙළ තාක්ෂණවේදී සිසුන් සඳහා අධ්‍යාපන ගොනු බෙදාගැනීමේ වේදිකාව</p>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-3">
            <a href="index.html" class="logo text-white text-2xl font-bold">AYEDU</a>
            <ul class="nav-list hidden sm:flex space-x-6">
                <li><a href="index.html" class="text-white hover:text-blue-200 transition duration-300 font-medium"><i class="fas fa-home"></i> මුල් පිටුව</a></li>
                <li><a href="et.html" class="text-white hover:text-blue-200 transition duration-300 font-medium"><i class="fas fa-cogs"></i> ඉංජිනේරු තාක්ෂණවේදය</a></li>
                <li><a href="sft.html" class="text-white hover:text-blue-200 transition duration-300 font-medium"><i class="fas fa-code"></i> තාක්ෂණවේදය සදහා විද්‍යාව</a></li>
                <li><a href="ict.html" class="text-white hover:text-blue-200 transition duration-300 font-medium"><i class="fas fa-computer"></i> තොරතුරු සන්නිවේදන තාක්ෂණය</a></li>
            </ul>
            <div class="nav-right flex items-center">
                <div class="search-box flex">
                    <input type="text" placeholder="ගොනු සොයන්න..." id="searchInput" class="px-3 py-1 rounded-l-md focus:outline-none text-gray-800">
                    <button class="btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-r-md" onclick="searchFiles()"><i class="fas fa-search"></i></button>
                </div>
                <a href="login.html" class="login-link ml-4 text-white hover:text-blue-200 transition duration-300 font-medium hidden sm:inline-block"><i class="fas fa-user-circle"></i> පිවිසෙන්න</a>
                <button class="text-white sm:hidden ml-4 text-xl"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">

        <!-- AI Tools Section -->
        <section id="ai-tools" class="mb-12 p-6 bg-white rounded-xl shadow-2xl">
            <h2 class="text-3xl font-extrabold text-blue-700 mb-6 border-b-2 border-blue-200 pb-2 flex items-center">
                <i class="fas fa-rocket mr-3"></i> AYEDU AI HUB
            </h2>
            <p class="text-gray-600 mb-8 text-lg">ඔබගේ අධ්‍යාපන කටයුතු පහසු කර ගැනීමට නිර්මාණය කරන ලද නවීනතම AI මෙවලම් මෙතැනින් තෝරන්න. (අත්හදා බැලීමේ සංස්කරණය)</p>
            <div id="aiToolButtons" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Rendered by JS -->
            </div>
        </section>

        <!-- Statistics -->
        <section id="statistics" class="mb-12">
            <h2 class="text-3xl font-extrabold text-blue-700 mb-6 border-b-2 border-blue-200 pb-2 flex items-center">
                <i class="fas fa-chart-bar mr-3"></i> වේදිකාවේ සංඛ්‍යාලේඛන
            </h2>
            <div class="flex flex-wrap -mx-3">
                <div class="w-full md:w-1/3 px-3">
                    <div class="stat-item"><h3 id="filesCount">150+</h3><p>ගොනු ප්‍රමාණය</p></div>
                </div>
                <div class="w-full md:w-1/3 px-3">
                    <div class="stat-item"><h3 id="usersCount">2.5K+</h3><p>ලියාපදිංචි පරිශීලකයින්</p></div>
                </div>
                <div class="w-full md:w-1/3 px-3">
                    <div class="stat-item"><h3 id="downloadsCount">10K+</h3><p>බාගත කිරීම්</p></div>
                </div>
            </div>
        </section>

        <!-- Subjects -->
        <section id="subjects" class="mb-12">
            <h2 class="text-3xl font-extrabold text-blue-700 mb-6 border-b-2 border-blue-200 pb-2 flex items-center">
                <i class="fas fa-book-open mr-3"></i> ප්‍රධාන විෂයන්
            </h2>
            <div class="flex flex-wrap justify-center -m-4">
                <div class="p-4 w-full sm:w-1/2 lg:w-1/3">
                    <div class="subject-card" onclick="window.location.href='et.html'">
                        <i class="fas fa-cogs"></i><h3>ඉංජිනේරු තාක්ෂණවේදය (E.T)</h3><p>ප්‍රායෝගික පුහුණුවට වැදගත් වන ගොනු.</p>
                    </div>
                </div>
                <div class="p-4 w-full sm:w-1/2 lg:w-1/3">
                    <div class="subject-card" onclick="window.location.href='sft.html'">
                        <i class="fas fa-code"></i><h3>මෘදුකාංග තාක්ෂණවේදය (S.F.T)</h3><p>කේතකරණය සහ ඇල්ගොරිතම ගොනු.</p>
                    </div>
                </div>
                <div class="p-4 w-full sm:w-1/2 lg:w-1/3">
                    <div class="subject-card" onclick="window.location.href='ict.html'">
                        <i class="fas fa-microchip fa-pulse text-blue-600" style="--fa-animation-duration: 3s;"></i>
                        <h3>තොරතුරු තාක්ෂණය (I.C.T)</h3><p>තොරතුරු පද්ධති සහ දත්ත ගබඩා ගොනු.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Content Focus -->
        <section id="content-focus" class="flex flex-wrap -mx-3 mb-10">
            <div class="col-md-6 w-full md:w-1/2 px-3 mb-6 md:mb-0">
                <div class="bg-white p-6 rounded-xl shadow-lg h-full">
                    <h4 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4"><i class="fas fa-upload mr-2 text-blue-500"></i> අලුතින් එක් කළ ගොනු</h4>
                    <ul><li>E.T - Power Generation (Lec 5)</li><li>S.F.T - Python OOP Practice Sheet</li><li>I.C.T - Database Normalization Guide</li><li>E.T - Circuit Diagrams for Labs</li><li>I.C.T - Web Development Basics</li></ul>
                </div>
            </div>
            <div class="col-md-6 w-full md:w-1/2 px-3">
                <div class="bg-white p-6 rounded-xl shadow-lg h-full">
                    <h4 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4"><i class="fas fa-star mr-2 text-yellow-500"></i> ජනප්‍රිය ගොනු</h4>
                    <ul><li>E.T - Model Papers 2024</li><li>S.F.T - Past Papers Collection (2010-2023)</li><li>I.C.T - Revision Notes for Unit 3</li><li>General - Time Management for A/L</li><li>S.F.T - C++ Data Structures Tutorial</li></ul>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p class="text-sm">&copy; 2024 AYEDU. සියලු හිමිකම් ඇවිරිණි.</p>
        <div class="social-links mt-2">
            <a href="#" class="text-gray-400 hover:text-white mx-2"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="text-gray-400 hover:text-white mx-2"><i class="fab fa-twitter"></i></a>
            <a href="#" class="text-gray-400 hover:text-white mx-2"><i class="fab fa-instagram"></i></a>
        </div>
    </footer>


    <!-- --- UNIQUE AI TOOL MODAL CONTAINER --- -->
    <div id="aiToolModal" class="modal">
        <div class="modal-content-custom overflow-hidden" id="modalContainer">
            <!-- Header (Always Visible) -->
            <div class="flex justify-between items-center px-6 py-4 bg-white border-b border-gray-100 flex-shrink-0 z-10">
                <div class="flex items-center">
                    <div id="modalIconContainer" class="w-10 h-10 rounded-full flex items-center justify-center mr-3 text-white"></div>
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-800">AI Tool</h2>
                </div>
                <span class="close-btn text-gray-400 hover:text-red-500" onclick="closeModal()">&times;</span>
            </div>
            
            <!-- Dynamic Tool Interface -->
            <div id="toolInterfaceRoot" class="flex-grow flex flex-col overflow-hidden relative">
                <!-- Content Injected Here -->
            </div>
        </div>
    </div>


    <script>
        // --- Global Setup ---
        const API_KEY = "AIzaSyD3sjhH-FUi6LZ4FRuKSc_142JRUyX786w"; 
        const GEMINI_TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const IMAGEN_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict";
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";

        // Quiz Schema
        const QUIZ_SCHEMA = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING" },
                    "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "correctAnswerIndex": { "type": "NUMBER" }
                }
            }
        };

        // --- AI Tools Configuration (with Themes & Colors) ---
        const aiTools = [
            { id: 'chatAssistant', name: 'සාමාන්‍ය කතාබස්', icon: 'fas fa-comments', color: '#0084ff', type: 'CHAT', model: 'gemini-2.5-flash', systemPrompt: 'Act as a friendly, helpful AI assistant. Respond in Sinhala.' },
            { id: 'translator', name: 'භාෂා පරිවර්තක', icon: 'fas fa-language', color: '#8b5cf6', type: 'TRANSLATOR', model: 'gemini-2.5-flash', systemPrompt: 'Translate text to {targetLang}. Return only translation.' },
            { id: 'conceptExplainer', name: 'සංකල්ප පැහැදිලි කරන්නා', icon: 'fas fa-lightbulb', color: '#f59e0b', type: 'CONCEPT', model: 'gemini-2.5-flash', systemPrompt: 'Explain concepts simply in Sinhala.' },
            { id: 'quizGenerator', name: 'ප්‍රශ්න පත්‍ර ජනකය', icon: 'fas fa-file-circle-question', color: '#ef4444', type: 'QUIZ', model: 'gemini-2.5-flash', systemPrompt: 'Generate 5 MCQ questions in JSON format.', schema: QUIZ_SCHEMA },
            { id: 'ttsReader', name: 'පාඩම් කියවනය (Audio)', icon: 'fas fa-headphones', color: '#ec4899', type: 'AUDIO', model: 'gemini-2.5-flash-preview-tts', systemPrompt: 'Speak text.' },
            { id: 'summarizer', name: 'සාරාංශකරණ', icon: 'fas fa-compress-alt', color: '#10b981', type: 'SUMMARIZER', model: 'gemini-2.5-flash', systemPrompt: 'Summarize in Sinhala.' },
            { id: 'essayWriter', name: 'රචනා ලේඛක', icon: 'fas fa-pen-nib', color: '#6366f1', type: 'ESSAY', model: 'gemini-2.5-flash', systemPrompt: 'Write an essay in Sinhala.' },
            { id: 'codeAnalyzer', name: 'කේත විචාරක', icon: 'fas fa-code', color: '#1e293b', type: 'CODE', model: 'gemini-2.5-flash', systemPrompt: 'Analyze code and explain bugs in Sinhala.' },
            { id: 'imageGenerator', name: 'රූප ජනකය', icon: 'fas fa-image', color: '#d946ef', type: 'IMAGE', model: 'imagen-3.0', systemPrompt: 'Generate image.' },
            { id: 'grammarChecker', name: 'ව්‍යාකරණ පරීක්ෂක', icon: 'fas fa-check-double', color: '#0ea5e9', type: 'GRAMMAR', model: 'gemini-2.5-flash', systemPrompt: 'Correct grammar in Sinhala.' },
            { id: 'ideaGenerator', name: 'අදහස් උත්පාදක', icon: 'fas fa-brain', color: '#f97316', type: 'IDEA', model: 'gemini-2.5-flash', systemPrompt: 'Generate creative ideas in Sinhala.' },
        ];

        let currentTool = null;
        let chatHistory = [];
        let isLoading = false;

        const translationLanguages = [
            { code: "Sinhala", name: "සිංහල" }, { code: "English", name: "English" }, { code: "Tamil", name: "දෙමළ" },
            { code: "Japanese", name: "ජපන්" }, { code: "Korean", name: "කොරියානු" }, { code: "French", name: "ප්‍රංශ" }
        ];

        // --- Core Functions ---

        function renderAITools() {
            const container = document.getElementById('aiToolButtons');
            container.innerHTML = '';
            aiTools.forEach(tool => {
                container.innerHTML += `
                    <button class="ai-tool-btn flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl shadow-md hover:shadow-xl text-gray-700 active:bg-gray-50 group" onclick="openTool('${tool.id}')">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-3 transition-transform group-hover:scale-110" style="background-color: ${tool.color}20; color: ${tool.color}">
                            <i class="${tool.icon} text-2xl"></i>
                        </div>
                        <span class="font-semibold text-center text-xs sm:text-sm group-hover:text-blue-600">${tool.name}</span>
                    </button>
                `;
            });
        }

        function openTool(toolId) {
            currentTool = aiTools.find(t => t.id === toolId);
            const modal = document.getElementById('aiToolModal');
            const container = document.getElementById('toolInterfaceRoot');
            
            // Set Header Styling
            document.getElementById('modalTitle').innerText = currentTool.name;
            const iconContainer = document.getElementById('modalIconContainer');
            iconContainer.style.backgroundColor = currentTool.color;
            iconContainer.innerHTML = `<i class="${currentTool.icon}"></i>`;
            
            modal.style.display = 'flex';
            container.innerHTML = getToolInterfaceHTML(currentTool);
            
            // Initialize Tool Specific Logic
            if(currentTool.type === 'CHAT') renderChatHistory();
        }

        function closeModal() {
            document.getElementById('aiToolModal').style.display = 'none';
            chatHistory = []; // Reset chat on close for simple session management
        }

        // --- UNIQUE INTERFACE GENERATOR ---
        function getToolInterfaceHTML(tool) {
            const loadingHtml = `<div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-50 hidden flex-col items-center justify-center backdrop-blur-sm"><div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-3"></div><p class="text-blue-600 font-bold animate-pulse">සකසමින් පවතී...</p></div>`;

            // 1. CHAT INTERFACE (WhatsApp/Messenger Style)
            if (tool.type === 'CHAT') {
                return `
                    ${loadingHtml}
                    <div class="theme-chat-bg flex-grow flex flex-col overflow-hidden relative">
                        <div id="chatOutput" class="flex-grow overflow-y-auto p-4 custom-scroll flex flex-col gap-3"></div>
                        <div class="bg-white p-3 border-t border-gray-200 flex items-center gap-2">
                            <input type="text" id="toolInput" class="flex-grow p-3 rounded-full border border-gray-300 focus:outline-none focus:border-blue-500 bg-gray-50" placeholder="පණිවිඩය ටයිප් කරන්න..." onkeydown="handleEnter(event)">
                            <button onclick="runTool()" class="w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center shadow-lg transition-transform hover:scale-105"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                `;
            }

            // 2. TRANSLATOR INTERFACE (Google Translate Style)
            if (tool.type === 'TRANSLATOR') {
                const options = translationLanguages.map(l => `<option value="${l.code}">${l.name}</option>`).join('');
                return `
                    ${loadingHtml}
                    <div class="flex flex-col md:flex-row h-full bg-gray-50">
                        <div class="flex-1 flex flex-col border-r border-gray-200 p-4 bg-white">
                            <label class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">Original Text</label>
                            <textarea id="toolInput" class="flex-grow w-full resize-none outline-none text-lg text-gray-800 placeholder-gray-300" placeholder="මෙහි ලියන්න..."></textarea>
                        </div>
                        <div class="h-px md:h-full md:w-px bg-gray-200"></div>
                        <div class="flex-1 flex flex-col p-4 bg-blue-50/50">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-blue-500 uppercase tracking-wider">Translation</label>
                                <select id="targetLang" class="text-sm bg-white border border-gray-200 rounded px-2 py-1 focus:outline-none text-gray-700 font-semibold">${options}</select>
                            </div>
                            <div id="toolOutput" class="flex-grow w-full text-lg text-gray-800 font-medium overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t border-gray-200 flex justify-end"><button onclick="runTool()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 transition">පරිවර්තනය කරන්න</button></div>
                `;
            }

            // 3. CODE ANALYZER (VS Code Style)
            if (tool.type === 'CODE') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full theme-code-bg">
                        <div class="flex items-center bg-[#252526] px-4 py-2 text-xs text-gray-400 border-b border-[#3e3e3e]">
                            <span class="mr-4 hover:text-white cursor-pointer"><i class="fas fa-file-code mr-1"></i> index.js</span>
                            <span class="flex-grow"></span>
                            <span><i class="fas fa-circle text-red-500 mr-1"></i> 1 Error</span>
                        </div>
                        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                            <textarea id="toolInput" class="code-input flex-1 p-4 resize-none outline-none custom-scroll text-sm leading-relaxed" spellcheck="false" placeholder="// Paste your code here..."></textarea>
                            <div id="toolOutput" class="code-output flex-1 p-4 overflow-y-auto custom-scroll text-sm leading-relaxed hidden md:block border-t md:border-t-0 md:border-l border-[#3e3e3e]">/* Analysis results will appear here... */</div>
                        </div>
                        <div class="p-2 bg-[#007acc] text-white flex justify-end cursor-pointer hover:bg-[#0062a3]" onclick="runTool()">
                            <span class="text-xs font-bold uppercase flex items-center px-4 py-1"><i class="fas fa-play mr-2"></i> Run Analysis</span>
                        </div>
                    </div>
                `;
            }

            // 4. ESSAY WRITER (Google Docs/Paper Style)
            if (tool.type === 'ESSAY') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full theme-paper-bg overflow-hidden relative">
                        <div class="bg-white border-b p-2 flex items-center justify-center gap-4 shadow-sm z-10">
                            <div class="w-full max-w-2xl flex items-center">
                                <i class="fas fa-heading text-gray-400 mr-3"></i>
                                <input type="text" id="toolInput" class="paper-input flex-grow text-lg font-semibold py-1 focus:outline-none" placeholder="රචනාවේ මාතෘකාව මෙතැන ලියන්න...">
                                <button onclick="runTool()" class="ml-4 bg-indigo-600 text-white px-4 py-1.5 rounded-md text-sm font-bold shadow-sm hover:bg-indigo-700">Write</button>
                            </div>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 md:p-8 custom-scroll flex justify-center">
                            <div id="toolOutput" class="paper-sheet w-full max-w-2xl min-h-[600px] text-gray-700">
                                <p class="text-gray-400 italic text-center mt-10">ඔබේ රචනාව මෙහි ලියැවෙනු ඇත...</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 5. AUDIO / LESSON NARRATOR (Music Player Style)
            if (tool.type === 'AUDIO') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full theme-audio-bg items-center justify-center p-6 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,...')"></div>
                        <div class="bg-white/10 backdrop-blur-md rounded-3xl p-8 w-full max-w-md border border-white/20 shadow-2xl relative z-10">
                            <div class="w-32 h-32 bg-white/20 rounded-full mx-auto mb-6 flex items-center justify-center shadow-inner">
                                <i class="fas fa-music text-5xl text-white/80"></i>
                            </div>
                            <textarea id="toolInput" class="w-full bg-black/20 border-none rounded-xl p-4 text-white placeholder-white/50 mb-6 resize-none h-32 focus:ring-2 focus:ring-white/50 outline-none" placeholder="කියවිය යුතු පාඩම මෙහි අලවන්න..."></textarea>
                            
                            <!-- Audio Visualization Placeholder -->
                            <div id="visualizer" class="audio-visualizer mb-6 opacity-0 transition-opacity">
                                <div class="audio-bar" style="animation-delay: 0s"></div>
                                <div class="audio-bar" style="animation-delay: 0.1s"></div>
                                <div class="audio-bar" style="animation-delay: 0.2s"></div>
                                <div class="audio-bar" style="animation-delay: 0.3s"></div>
                                <div class="audio-bar" style="animation-delay: 0.4s"></div>
                            </div>

                            <audio id="audioPlayer" class="hidden"></audio>

                            <button onclick="runTool()" class="w-full bg-white text-indigo-600 font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-50 transition transform hover:scale-105 flex items-center justify-center">
                                <i class="fas fa-play mr-2"></i> හඬ කවන්න (Play)
                            </button>
                        </div>
                    </div>
                `;
            }

            // 6. QUESTION PAPER GENERATOR (Exam Paper Style)
            if (tool.type === 'QUIZ') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full bg-gray-100">
                        <div class="bg-white p-6 shadow-sm z-10 flex flex-col gap-3">
                            <label class="font-bold text-gray-700">විෂය නිර්දේශය / සටහන් (Syllabus/Notes):</label>
                            <textarea id="toolInput" class="w-full p-3 border border-gray-300 rounded-lg h-24 resize-none focus:ring-2 focus:ring-red-500 outline-none" placeholder="පාඩම් කොටස මෙහි අලවන්න..."></textarea>
                            <button onclick="runTool()" class="self-end bg-red-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-red-600"><i class="fas fa-cog fa-spin mr-2 hover:animate-none"></i> පත්‍රය සාදන්න</button>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 md:p-8 custom-scroll flex justify-center">
                            <div id="toolOutput" class="bg-white w-full max-w-3xl min-h-[500px] shadow-md p-8 border-t-8 border-red-500 relative">
                                <div class="border-b-2 border-black pb-4 mb-6 text-center">
                                    <h1 class="text-2xl font-serif font-bold uppercase tracking-widest">විභාග ප්‍රශ්න පත්‍රය - 2024</h1>
                                    <p class="text-gray-500 font-serif italic">කාලය: පැය 01 යි</p>
                                </div>
                                <p class="text-gray-400 text-center py-10">ප්‍රශ්න පත්‍රය මෙහි දර්ශනය වේ...</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 7. IMAGE GENERATOR (Gallery Style)
            if (tool.type === 'IMAGE') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full bg-gray-900 text-white">
                        <div class="flex-grow flex items-center justify-center p-4 overflow-hidden relative" id="imageContainer">
                            <div class="absolute inset-0 bg-gradient-to-br from-purple-900/20 to-black pointer-events-none"></div>
                            <div id="toolOutput" class="max-w-full max-h-full rounded-lg shadow-2xl overflow-hidden flex items-center justify-center border border-white/10 p-4 bg-black/40 backdrop-blur">
                                <i class="fas fa-image text-6xl text-white/20"></i>
                            </div>
                        </div>
                        <div class="p-6 bg-gray-800 border-t border-gray-700 flex gap-4 items-center">
                            <input type="text" id="toolInput" class="flex-grow bg-gray-700 border-none rounded-full px-6 py-3 text-white focus:ring-2 focus:ring-purple-500 outline-none placeholder-gray-400" placeholder="ඔබට අවශ්‍ය රූපය විස්තර කරන්න..." onkeydown="handleEnter(event)">
                            <button onclick="runTool()" class="bg-purple-600 hover:bg-purple-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:rotate-12">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            // 8. IDEA GENERATOR (Sticky Notes Style)
            if (tool.type === 'IDEA') {
                return `
                    ${loadingHtml}
                    <div class="flex flex-col h-full theme-sticky-bg relative overflow-hidden">
                        <div class="p-6 flex justify-center z-10">
                            <div class="bg-white p-2 rounded-full shadow-xl flex items-center w-full max-w-xl border-4 border-orange-200">
                                <input type="text" id="toolInput" class="flex-grow px-4 py-2 rounded-full outline-none text-gray-700 font-handwriting text-lg" placeholder="මාතෘකාවක් දෙන්න (උදා: නව ව්‍යාපාර)..." onkeydown="handleEnter(event)">
                                <button onclick="runTool()" class="bg-orange-500 text-white rounded-full w-10 h-10 hover:bg-orange-600"><i class="fas fa-lightbulb"></i></button>
                            </div>
                        </div>
                        <div id="toolOutput" class="flex-grow overflow-y-auto p-8 custom-scroll grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 content-start">
                             <!-- Stickies go here -->
                             <div class="sticky-note opacity-50"><p class="text-center text-gray-500">අදහස් මෙහි ඇලවෙනු ඇත...</p></div>
                        </div>
                    </div>
                `;
            }

            // DEFAULT / TEXT TOOLS (Concept, Summarizer, Grammar) - Clean Modern Style
            return `
                ${loadingHtml}
                <div class="flex flex-col h-full bg-white">
                    <div class="p-6 bg-gray-50 border-b border-gray-100">
                        <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide opacity-70">Input</label>
                        <textarea id="toolInput" class="w-full bg-white border border-gray-200 rounded-xl p-4 focus:ring-2 focus:ring-${currentTool.color.replace('#','')} focus:border-transparent outline-none resize-none h-32 shadow-sm transition" placeholder="මෙහි ලියන්න..."></textarea>
                        <div class="flex justify-end mt-3">
                            <button onclick="runTool()" class="px-6 py-2 rounded-lg font-bold text-white shadow hover:shadow-lg transition transform hover:-translate-y-0.5" style="background-color: ${currentTool.color}"><i class="fas fa-bolt mr-2"></i> ක්‍රියාත්මක කරන්න</button>
                        </div>
                    </div>
                    <div class="flex-grow p-6 overflow-y-auto custom-scroll bg-white">
                        <label class="block text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide opacity-70">Result</label>
                        <div id="toolOutput" class="prose max-w-none text-gray-800 leading-relaxed"></div>
                    </div>
                </div>
            `;
        }

        // --- Logic Handlers ---

        function handleEnter(e) { if(e.key === 'Enter') runTool(); }

        async function runTool() {
            if (isLoading) return;
            const inputEl = document.getElementById('toolInput');
            const outputEl = document.getElementById('toolOutput');
            const loader = document.getElementById('loadingOverlay');
            
            const text = inputEl ? inputEl.value.trim() : '';
            if (!text && currentTool.type !== 'CHAT') return alert("කරුණාකර යමක් ඇතුළත් කරන්න.");

            // UI Loading State
            isLoading = true;
            if(loader) loader.classList.replace('hidden', 'flex');
            
            try {
                // 1. Image Gen
                if (currentTool.type === 'IMAGE') {
                    const result = await callApi(IMAGEN_API_URL, { instances: [{ prompt: text }], parameters: { sampleCount: 1 } });
                    const b64 = result.predictions?.[0]?.bytesBase64Encoded;
                    if(b64) outputEl.innerHTML = `<img src="data:image/png;base64,${b64}" class="rounded shadow-lg max-h-[500px] object-contain">`;
                }
                
                // 2. Audio Gen
                else if (currentTool.type === 'AUDIO') {
                    const viz = document.getElementById('visualizer');
                    viz.style.opacity = '1'; // Show fake visualizer
                    const result = await callApi(TTS_API_URL, {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } } },
                        model: "gemini-2.5-flash-preview-tts"
                    });
                    const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (audioData) {
                        const wav = pcmToWav(new Int16Array(base64ToArrayBuffer(audioData)), 24000);
                        const audioPlayer = document.getElementById('audioPlayer');
                        audioPlayer.src = URL.createObjectURL(wav);
                        audioPlayer.play();
                        audioPlayer.onended = () => viz.style.opacity = '0';
                    }
                }

                // 3. Quiz Gen
                else if (currentTool.type === 'QUIZ') {
                    const result = await callApi(GEMINI_TEXT_API_URL, {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: currentTool.schema },
                        systemInstruction: { parts: [{ text: currentTool.systemPrompt }] }
                    });
                    const quizData = JSON.parse(result.candidates[0].content.parts[0].text);
                    let html = `<div class="border-b-2 border-black pb-4 mb-6 text-center"><h1 class="text-2xl font-serif font-bold uppercase">විභාග ප්‍රශ්න පත්‍රය</h1></div>`;
                    quizData.forEach((q, i) => {
                        html += `<div class="mb-6"><p class="font-bold mb-2">${i+1}. ${q.question}</p><ul class="pl-5 list-[upper-alpha] space-y-1">${q.options.map(o=>`<li>${o}</li>`).join('')}</ul></div>`;
                    });
                    outputEl.innerHTML = html;
                }

                // 4. Idea Gen (Stickies)
                else if (currentTool.type === 'IDEA') {
                    const result = await generateText(text);
                    const ideas = result.split('\n').filter(i => i.trim().length > 0);
                    outputEl.innerHTML = ideas.map(idea => `<div class="sticky-note"><p class="text-gray-800 text-lg">${idea.replace(/^\d+\.\s*/, '')}</p></div>`).join('');
                }

                // 5. Chat
                else if (currentTool.type === 'CHAT') {
                    const chatOut = document.getElementById('chatOutput');
                    chatOut.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
                    inputEl.value = ''; // Clear input immediately
                    chatOut.scrollTop = chatOut.scrollHeight;
                    
                    chatHistory.push({ role: 'user', parts: [{ text }] });
                    const reply = await generateText(null, chatHistory);
                    chatOut.innerHTML += `<div class="chat-bubble chat-ai">${marked.parse(reply)}</div>`;
                    chatHistory.push({ role: 'model', parts: [{ text: reply }] });
                    chatOut.scrollTop = chatOut.scrollHeight;
                }

                // 6. General Text Tools (Essay, Code, Concept, etc.)
                else {
                    let prompt = text;
                    if (currentTool.type === 'TRANSLATOR') prompt = `Translate to ${document.getElementById('targetLang').value}: ${text}`;
                    
                    const reply = await generateText(prompt);
                    
                    if (currentTool.type === 'CODE') {
                        outputEl.innerHTML = `<pre class="text-sm font-mono whitespace-pre-wrap">${reply}</pre>`;
                        outputEl.classList.remove('hidden'); // Show output panel in code view
                    } else {
                        outputEl.innerHTML = marked.parse(reply);
                    }
                }

            } catch (err) {
                alert("දෝෂයක් සිදුවිය: " + err.message);
            } finally {
                isLoading = false;
                if(loader) loader.classList.replace('flex', 'hidden');
            }
        }

        // --- Helper API Functions ---
        async function generateText(input, history = null) {
            const payload = {
                contents: history || [{ parts: [{ text: input }] }],
                systemInstruction: { parts: [{ text: currentTool.systemPrompt }] }
            };
            const res = await callApi(GEMINI_TEXT_API_URL, payload);
            return res.candidates[0].content.parts[0].text;
        }

        async function callApi(url, payload) {
            const res = await fetch(`${url}?key=${API_KEY}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error((await res.json()).error.message);
            return await res.json();
        }

        // Audio Utils
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        }
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcm16.byteLength, true); writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(view, 36, 'data'); view.setUint32(40, pcm16.byteLength, true);
            for (let i = 0; i < pcm16.length; i++) view.setInt16(44 + i * 2, pcm16[i], true);
            return new Blob([view], { type: 'audio/wav' });
        }

        // Init
        window.onload = function() {
            renderAITools();
            document.querySelectorAll('.subject-card').forEach((c, i) => setTimeout(() => { c.style.opacity=1; c.style.transform='translateY(0)' }, i*100));
        };
        
        // Render empty chat history helper
        function renderChatHistory() {
            const chatOut = document.getElementById('chatOutput');
            chatOut.innerHTML = `<div class="text-center text-gray-400 text-sm py-4">සංවාදය ආරම්භ කරන්න...</div>`;
        }

    </script>
</body>
</html>
